name: Release
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to release'
        type: environment
        required: true

jobs:
  get_env:
    uses: ./.github/workflows/set_env.yml
    
  release_echo:
    needs: get_env
    env:
      ENVIRONMENT: ${{ inputs.environment }}
      AAA: &{{ needs.get_env.outputs.aaa }}
      
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - run: |
          echo "Environment: AAA"
  
  build_and_test:
    name: Build & test
    uses: ./.github/workflows/build_and_test.yml
    
  deploy_to_staging:
    name: Deploy to Staging
    needs: build_and_test
    uses: ./.github/workflows/deploy.yml
    with:
      environment: Staging
    secrets: inherit
    
  deploy_to_production:
    name: Deploy to Production
    needs: [build_and_test, deploy_to_staging]
    uses: ./.github/workflows/deploy.yml
    with:
      environment: Production
    secrets: inherit
